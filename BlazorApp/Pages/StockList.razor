@page "/stocks"
@using DataService.Models
@inject IDataLayer  DataLayer
@inject IJSRuntime Js

@if (stocks == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="column" style="width:20%; float: left">
            <select multiple size="50" @onchange="@(async (arg) => await OnStockChangeAsync(arg))">
                @foreach (var stock in stocks)
                {
                    <option value="@stock.StockId">@stock.StockId - @stock.Name (@stock.Industry)</option>
                }
            </select>

        </div>
        <div class="column" style="width:70%">
            <iframe id="StockPage" scrolling="auto" width="1200" height="1000" frameborder="0" />
        </div>
        <div class="column" style="width:10%;position:relative;left:30px">
            <input type="button" value="CMoney" @onclick="@(async () => await OnUrlChangeAsync(1))" /><br />
            <input type="button" value="富邦資料" @onclick="@(async () => await OnUrlChangeAsync(2))" /><br />
            <input type="button" value="融資融券" @onclick="@(async () => await OnUrlChangeAsync(3))" /><br />
            <input type="button" value="財報狗" @onclick="@(async () => await OnUrlChangeAsync(4))" /><br />
        </div>
    </div>

}

@code{
    int currentUrlIndex = 1;
    string currentStockId = "2330";
   
    string currentUrl = "https://www.cmoney.tw/follow/channel/stock-{0}?chart=d";
    Stocks[] stocks;

    Dictionary<int, string> urls = new Dictionary<int, string>
    {
        {1, "https://www.cmoney.tw/follow/channel/stock-{0}?chart=d"},
        {2, "https://fubon-ebrokerdj.fbs.com.tw/z/zc/zco/zco_{0}.djhtm"},
        {3, "https://www.cnyes.com/twstock/Margin/{0}.htm"},
        {4, "https://statementdog.com/analysis/tpe/{0}"},
    };
}

@functions{
    protected override async Task OnInitializedAsync()
    {
        stocks = await DataLayer.GetStocksAsync();
    }

    async Task OnStockChangeAsync(ChangeEventArgs e)
    {
        currentUrlIndex = 1;
        currentStockId = (string)e.Value;
        await OnSetUrlAsync();
    }

    async Task OnUrlChangeAsync(int index)
    {
        currentUrlIndex = index;
        currentUrl = urls[currentUrlIndex];

        await OnSetUrlAsync();
    }

    async Task OnSetUrlAsync()
    {
        string url = string.Format(currentUrl, currentStockId);
        string methodName = currentUrlIndex <= 3 ? "setStockPage" : "goToUrl";
        await Js.InvokeAsync<object>(methodName, url);
    }
}